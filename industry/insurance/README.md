# 保険業向け Dify ワークフローサンプル集

保険業の主要業務シーンに対応した 10 の Dify ワークフロー DSL サンプルです。
すべて `DIFY_WORKFLOW_GOLDEN_RULES.md` に準拠し、Dify へのインポートが可能な形式です。

---

## サンプル一覧

| # | ファイル名 | 業務シーン | パターン | モード | ノード数 |
|---|---|---|---|---|---|
| 1 | ins-01-policy-terms-search.yml | 保険約款・規程検索 | RAG | workflow | 4 |
| 2 | ins-02-claim-review.yml | 保険金請求審査 | PE → Code → IF/ELSE | workflow | 8 |
| 3 | ins-03-customer-inquiry.yml | 契約者問い合わせ対応 | QC 4分岐 + KR | advanced-chat | 11 |
| 4 | ins-04-fraud-claim-detection.yml | 不正請求検知分析 | HTTP → LLM → Code(構造化抽出) → IF/ELSE + JSON安全構築 | workflow | 12 |
| 5 | ins-05-agency-report.yml | 代理店実績レポート一括生成 | Iteration[HTTP] + LLM | workflow | 7 |
| 6 | ins-06-complaint-classification.yml | 苦情・クレーム自動分類 | QC 5分岐 + LLM×5 | workflow | 9 |
| 7 | ins-07-underwriting-draft.yml | 引受査定ドラフト作成支援 | 多入力 → Code → LLM | workflow | 4 |
| 8 | ins-08-premium-calculation.yml | 保険料試算・顧客向け説明 | Code(URLenc) → HTTP → Code → LLM | workflow | 6 |
| 9 | ins-09-accident-report-draft.yml | 事故報告書ドラフト作成 | PE → Code → LLM → Template | workflow | 6 |
| 10 | ins-10-product-comparison.yml | 保険商品比較レポート | Iteration[LLM] → LLM | workflow | 7 |

**合計ノード数**: 74 ノード

---

## 各ワークフロー詳細

### INS-01: 保険約款・規程検索

**対象部門**: コンプライアンス部門、営業部門、コールセンター
**業務シーン**: 保険約款（普通保険約款、特約条項）、社内規程（引受規程、支払規程、個人情報保護規程等）、保険業法・保険法等の関連法令をナレッジベースから検索し、LLMが約款名・条項番号を明示して回答する。

```
開始 → 約款・規程検索(Knowledge Retrieval) → 約款回答生成(LLM, context有効) → 終了
```

| ノード | タイプ | 説明 |
|---|---|---|
| 開始 | start | `question` を入力 |
| 約款・規程検索 | knowledge-retrieval | 保険約款ナレッジベースを検索 (top_k: 5) |
| 約款回答生成 | llm | 検索結果をコンテキストとして回答 (temp: 0.2) |
| 終了 | end | `answer` を出力 |

**入力例**:
- `question`: `入院給付金の免責事由について教えてください`

**カスタマイズポイント**:
- `dataset_ids` を実際の約款ナレッジベースIDに変更
- 問い合わせ先内線番号（現在: 6001）を実際の番号に変更
- rerankingモデルを設定して検索精度を向上

---

### INS-02: 保険金請求審査

**対象部門**: 保険金支払部門、査定部門
**業務シーン**: 保険金請求書テキストからParameter Extractorで請求情報（契約者名、証券番号、事故日、請求種別、請求金額、入院日数）を抽出し、Codeで基本要件（請求種別有効性、金額上限、入院日数整合性）をチェック。合格ならLLMで査定レポート、不合格ならテンプレートで不備通知を生成。

```
開始 → 請求情報抽出(PE) → 基本要件チェック(Code) → 要件判定分岐(IF/ELSE)
                                                        ├─ [PASS] → 査定レポート生成(LLM)     ─┐
                                                        └─ [FAIL] → 不備通知生成(Template)     ─┤
                                                                                                  → 結果集約(Aggregator) → 終了
```

| ノード | タイプ | 説明 |
|---|---|---|
| 開始 | start | `claim_text` を入力 |
| 請求情報抽出 | parameter-extractor | 契約者名、証券番号、事故日、請求種別、請求金額、入院日数を抽出 |
| 基本要件チェック | code | 請求種別・金額・入院日数の妥当性を判定 |
| 要件判定分岐 | if-else | Code出力の `result` が "PASS" か判定 |
| 査定レポート生成 | llm | 合格案件の査定レポートを生成 (temp: 0.3) |
| 不備通知生成 | template-transform | 不備項目を明示した通知を生成 |
| 結果集約 | variable-aggregator | 両分岐の出力を統合 |
| 終了 | end | `review_result` を出力 |

**入力例**:
- `claim_text`: `契約者: 田中花子、証券番号: LP-12345678、事故日: 2024年3月10日、請求種別: 入院、請求金額: 50万円、入院日数: 14日、診断名: 急性虫垂炎`

**カスタマイズポイント**:
- Code ノードの審査基準値（金額上限等）を自社の査定基準に変更
- Parameter Extractor の抽出パラメータを追加（例: 担当医師名、医療機関名）
- LLM の査定レポートフォーマットを自社テンプレートに合わせる

---

### INS-03: 契約者問い合わせ対応チャット

**対象部門**: コールセンター、カスタマーサービス部門
**業務シーン**: 契約者からの問い合わせを「契約内容確認」「保険金請求」「名義変更・住所変更」「その他」に4分類し、契約内容系はナレッジ検索+LLM、それ以外は専用LLMで回答。Chatflow形式で会話履歴を保持。

```
開始 → 問い合わせ分類(QC)
           ├─ [契約内容] → 契約KB検索(KR) → 契約対応LLM → 契約回答(Answer)
           ├─ [保険金請求]                → 請求対応LLM → 請求回答(Answer)
           ├─ [名義変更]                  → 変更対応LLM → 変更回答(Answer)
           └─ [その他]                    → 一般対応LLM → 一般回答(Answer)
```

| ノード | タイプ | 説明 |
|---|---|---|
| 開始 | start | `sys.query` を使用（Chatflow） |
| 問い合わせ分類 | question-classifier | 4クラス: 契約内容/保険金請求/名義変更/その他 |
| 契約KB検索 | knowledge-retrieval | 契約関連ナレッジベースを検索 |
| 契約対応LLM | llm | context有効 (temp: 0.3) |
| 請求対応LLM | llm | 保険金請求手続き案内 (temp: 0.3) |
| 変更対応LLM | llm | 名義変更・住所変更手続き案内 (temp: 0.3) |
| 一般対応LLM | llm | 一般的な問い合わせ対応 (temp: 0.3) |
| 契約/請求/変更/一般回答 | answer ×4 | 各分岐の回答を出力 |

**入力例**:
- `契約内容を確認したいのですが`
- `保険金の請求手続きを教えてください`
- `住所変更の手続きについて教えてください`

**カスタマイズポイント**:
- `dataset_ids` を実際の契約関連ナレッジベースIDに変更
- Question Classifier の分類ルールに自社固有のサービス名を追加
- 各LLMのシステムプロンプトに自社の商品情報・約款を反映

---

### INS-04: 不正請求検知分析・エスカレーション

**対象部門**: SIU（特別調査部門）、保険金支払部門
**業務シーン**: 請求IDを指定してAPIから保険金請求データを取得し、LLMで不正パターン（モラルリスク、過剰請求、書類偽造、多重請求、偽装事故）を分析。HIGHリスクまたは1000万円超の請求はJSON安全構築の上でSIU通知APIにエスカレーション。

```
開始 → URLエンコード(Code) → 請求データ取得(HTTP) → データ整形(Code) → 不正分析(LLM) → リスク判定抽出(Code) → エスカレーション判定(IF/ELSE)
                                                                                                                       ├─ [HIGH or 1000万超] → JSON構築(Code) → SIUエスカレーション通知(HTTP) ─┐
                                                                                                                       └─ [それ以外]         → 通常処理(Template)                            ─┤
                                                                                                                                                                                               → 結果集約(Aggregator) → 終了
```

| ノード | タイプ | 説明 |
|---|---|---|
| 開始 | start | `claim_id`, `alert_type` を入力 |
| URLエンコード | code | `urllib.parse.quote()` で請求IDをエンコード |
| 請求データ取得 | http-request | GET `/insurance-claims/{id}` で請求データ取得 |
| データ整形 | code | JSON解析、金額を `float()` 変換、請求サマリ生成 |
| 不正分析 | llm | 不正パターン分析、HIGH/MEDIUM/LOW判定 (temp: 0.2) |
| リスク判定抽出 | code | 正規表現で `リスク評価: HIGH/MEDIUM/LOW` を構造化抽出 |
| エスカレーション判定 | if-else | `risk_level` が "HIGH" (厳密一致) OR 金額 > 1000万円 |
| JSON構築 | code | `json.dumps()` でSIU通知ペイロードを安全構築 |
| SIUエスカレーション通知 | http-request | POST `/fraud/siu-escalate` で通知送信 |
| 通常処理 | template-transform | モニタリング記録レポートを生成 |
| 結果集約 | variable-aggregator | 両分岐の出力を統合 |
| 終了 | end | `analysis_result` を出力 |

**入力例**:
- `claim_id`: `CLM-20240315-001234`
- `alert_type`: `短期間複数請求`

**カスタマイズポイント**:
- HTTP Request のURLを実際の請求管理APIに変更
- IF/ELSE の金額閾値（現在: 1000万円）を自社基準に変更
- LLM の不正判定基準を自社のSIUポリシーに合わせる
- エスカレーション通知先を社内通知システム（Slack、Teams等）に変更

---

### INS-05: 代理店実績レポート一括生成

**対象部門**: 営業推進部門、代理店管理部門
**業務シーン**: カンマ区切りで指定した複数代理店の実績データ（新契約件数、保有契約件数、解約率、保険料収入、損害率等）をAPIから一括取得し、LLMが全体分析・優良代理店/要改善代理店の評価・営業戦略提言を含むレポートを生成。

```
開始 → 代理店配列化(Code) → 代理店イテレーション ──→ 結果集約(Code) → 営業分析(LLM) → 終了
                               └─ [実績API(HTTP)] ─┘
```

| ノード | タイプ | 説明 |
|---|---|---|
| 開始 | start | `agency_list`, `report_period` を入力 |
| 代理店配列化 | code | カンマ区切り → 配列変換 + レポート期間URLエンコード |
| 代理店イテレーション | iteration | 各代理店に対して並列API呼び出し |
| 実績API | http-request | 代理店実績データを取得（イテレーション子ノード） |
| 結果集約 | code | APIレスポンスを集約してサマリテキスト生成 |
| 営業分析 | llm | 全代理店データを分析し営業レポートを生成 (temp: 0.3) |
| 終了 | end | `report` を出力 |

**入力例**:
- `agency_list`: `AG-001, AG-002, AG-003, AG-004, AG-005`
- `report_period`: `2024Q3`

**カスタマイズポイント**:
- HTTP Request のURLを実際の代理店管理APIに変更
- 結果集約 Code ノードで取得するメトリクスを追加（例: 顧客満足度、研修受講率）
- LLM のレポートフォーマットを営業会議用テンプレートに合わせる
- `parallel_mode` を `false` にしてAPI負荷を軽減

---

### INS-06: 苦情・クレーム自動分類・対応案生成

**対象部門**: お客様相談室、コンプライアンス部門
**業務シーン**: 顧客からの苦情テキストを「保険金支払」「契約手続」「営業対応」「商品内容」「その他」の5カテゴリに自動分類し、カテゴリ別に専門的な対応案（感情分析・要約・推奨対応・エスカレーション要否）を生成する。

```
開始 → 苦情分類(QC 5分岐)
           ├─ [保険金支払] → 保険金支払対応(LLM) ─┐
           ├─ [契約手続]   → 契約手続対応(LLM)   ─┤
           ├─ [営業対応]   → 営業対応(LLM)       ─┤→ 結果集約(Aggregator) → 終了
           ├─ [商品内容]   → 商品内容対応(LLM)   ─┤
           └─ [その他]     → その他対応(LLM)     ─┘
```

| ノード | タイプ | 説明 |
|---|---|---|
| 開始 | start | `complaint_text`, `customer_segment`(select) を入力 |
| 苦情分類 | question-classifier | 5クラス: 保険金支払/契約手続/営業対応/商品内容/その他 |
| 保険金支払対応 | llm | 支払SLA・査定プロセスに基づく対応案 (temp: 0.3) |
| 契約手続対応 | llm | 手続き改善・書類要件に基づく対応案 (temp: 0.3) |
| 営業対応 | llm | 保険業法300条に基づくコンプライアンス対応案 (temp: 0.3) |
| 商品内容対応 | llm | 商品説明・適合性評価に基づく対応案 (temp: 0.3) |
| その他対応 | llm | 適切な担当部署への転送案内 (temp: 0.3) |
| 結果集約 | variable-aggregator | 5つのLLM出力を集約 |
| 終了 | end | `response` を出力 |

**入力例**:
- `complaint_text`: `3ヶ月前に入院給付金を請求しましたが、まだ支払われていません。何度電話しても「審査中」としか言われず、具体的な進捗を教えてもらえません。`
- `customer_segment`: `個人`

**カスタマイズポイント**:
- Question Classifier の分類カテゴリを自社の苦情分類体系に変更
- 各LLMの対応ルールに自社のクレーム対応マニュアルを反映
- `customer_segment` の選択肢を自社の顧客セグメントに変更

---

### INS-07: 引受査定ドラフト作成支援

**対象部門**: 引受査定部門、医務査定部門
**業務シーン**: 保険引受査定に必要な情報（申込者名、年齢、性別、職業、保険種類、保険金額、健康状態概要、既往歴）を入力し、Codeで整形した上でLLMが引受査定レポートのドラフト（申込概要、リスク評価、引受判定案、査定意見）を生成する。

```
開始(8入力) → 入力整形(Code) → 査定ドラフト生成(LLM, max_tokens: 8192) → 終了
```

| ノード | タイプ | 説明 |
|---|---|---|
| 開始 | start | 8パラメータ: applicant_name, age, gender, occupation, insurance_type, sum_insured, health_summary, medical_history |
| 入力整形 | code | 入力パラメータを査定レポート用に整形 |
| 査定ドラフト生成 | llm | 引受査定レポートフォーマットでドラフト生成 (temp: 0.3, max_tokens: 8192) |
| 終了 | end | `underwriting_draft` を出力 |

**入力例**:
- `applicant_name`: `鈴木一郎`
- `age`: `45`
- `gender`: `男性`
- `occupation`: `会社員（事務職）`
- `insurance_type`: `終身保険`
- `sum_insured`: `3000`（万円）
- `health_summary`: `BMI 24.5、血圧正常、直近の健康診断で異常なし`
- `medical_history`: `5年前に胃潰瘍で2週間入院、完治済み`

**カスタマイズポイント**:
- LLM の査定レポートフォーマットを自社のテンプレートに変更
- 入力パラメータを追加（例: 喫煙歴、BMI、家族歴）
- `max_tokens` を査定書の想定文量に応じて調整

---

### INS-08: 保険料試算・顧客向け説明

**対象部門**: 営業部門、窓口
**業務シーン**: 保険種類と年齢・性別等の条件を指定して保険料試算APIから試算結果を取得、Codeでパース後、顧客の加入目的（死亡保障/医療保障/老後資金/学資準備）に応じたわかりやすい説明をLLMが生成する。

```
開始 → URLエンコード(Code) → 保険料試算API(HTTP) → 試算結果解析(Code) → 顧客向け説明生成(LLM) → 終了
```

| ノード | タイプ | 説明 |
|---|---|---|
| 開始 | start | `insurance_type`, `customer_age`, `customer_gender`, `customer_purpose`(select) を入力 |
| URLエンコード | code | `urllib.parse.quote()` で保険種類をエンコード |
| 保険料試算API | http-request | GET `/premium-calc?type={}&age={}&gender={}` で試算結果取得 |
| 試算結果解析 | code | JSON解析、月払/年払保険料・保障金額・保障期間を整形 |
| 顧客向け説明生成 | llm | 加入目的に応じた説明生成 (temp: 0.5) |
| 終了 | end | `premium_explanation` を出力 |

**入力例**:
- `insurance_type`: `終身医療保険`
- `customer_age`: `35`
- `customer_gender`: `女性`
- `customer_purpose`: `医療保障`

**カスタマイズポイント**:
- HTTP Request のURLを実際の保険料試算APIに変更
- 試算結果解析 Code ノードのフィールド名をAPIレスポンスに合わせる
- LLM の注意事項に自社の保険料体系を反映
- `customer_purpose` の選択肢を追加（例: 介護保障、就業不能保障）

---

### INS-09: 事故報告書ドラフト作成

**対象部門**: 損害サービス部門、事故対応センター
**業務シーン**: 事故・災害の詳細テキストからParameter Extractorで情報（被保険者名、証券番号、事故日時、事故場所、事故種別、損害概要、相手方情報）を抽出し、Codeで検証・整形、LLMが事故状況の分析と初期対応レポートを生成、Templateで事故報告書フォーマットに整形する。

```
開始 → パラメータ抽出(PE) → 検証・整形(Code) → 事故分析・ドラフト(LLM) → 報告書フォーマット(Template) → 終了
```

| ノード | タイプ | 説明 |
|---|---|---|
| 開始 | start | `accident_details` を入力 |
| パラメータ抽出 | parameter-extractor | 被保険者名、証券番号、事故日時、場所、種別、損害概要、相手方を抽出 |
| 検証・整形 | code | 抽出パラメータの欠損チェック + 整形 |
| 事故分析・ドラフト | llm | 事故分析・初期対応レポート生成 (temp: 0.2) |
| 報告書フォーマット | template-transform | 公式フォーマットに整形 |
| 終了 | end | `accident_report_draft` を出力 |

**入力例**:
- `accident_details`: `被保険者: 佐藤太郎（証券番号: AP-98765432）、2024年3月15日午後2時頃、東京都渋谷区の交差点で自動車同士の接触事故。相手方車両の急な車線変更により衝突。被保険者車両の右前方に損傷、修理見積約80万円。相手方: 山田次郎、相手方保険会社: XX損保。`

**カスタマイズポイント**:
- Parameter Extractor の抽出項目を自社の報告書フォーマットに合わせて追加
- LLM の分析基準を自社の損害査定ガイドラインに更新
- Template の報告書フォーマットを自社の提出様式に変更

---

### INS-10: 保険商品比較レポート生成

**対象部門**: 商品企画部門、営業推進部門
**業務シーン**: 比較したい保険商品名を改行区切りで入力し、Iteration内のLLMが各商品を個別分析（カテゴリ、保障内容、保険料水準、特約、ターゲット顧客層）、その後LLMが比較観点に基づく総括レポートを生成する。

```
開始 → 商品配列化(Code) → 商品分析イテレーション ──→ 結果集約(Code) → 比較総括(LLM) → 終了
                             └─ [商品個別分析(LLM)] ─┘
```

| ノード | タイプ | 説明 |
|---|---|---|
| 開始 | start | `product_list`(改行区切り), `comparison_focus`(select) を入力 |
| 商品配列化 | code | 改行区切り → 配列変換 |
| 商品分析イテレーション | iteration | 各商品を並列でLLM分析 |
| 商品個別分析 | llm | カテゴリ/保障内容/保険料/特約/ターゲットを分析 (temp: 0.3) |
| 結果集約 | code | 個別分析結果を集約テキスト化 |
| 比較総括 | llm | 比較観点に基づく総括レポート生成 (temp: 0.3, max_tokens: 8192) |
| 終了 | end | `comparison_report` を出力 |

**入力例**:
- `product_list`:
  ```
  終身医療保険A
  定期保険B（10年）
  がん保険C
  個人年金保険D
  ```
- `comparison_focus`: `保障内容比較`

**カスタマイズポイント**:
- 個別分析 LLM のプロンプトに自社取扱商品の詳細情報を追加
- `comparison_focus` の選択肢を営業シーンに合わせて変更
- `parallel_mode` を `false` にしてAPI負荷を軽減

---

## インポート手順

1. Dify にログイン
2. 「スタジオ」→「DSLファイルをインポート」
3. 対象の `.yml` ファイルを選択
4. インポート後、以下をカスタマイズ:
   - **モデル設定**: `openai` / `gpt-4o-mini` を利用可能なモデルに変更
   - **API URL**: `api.example.com` を実際のAPIエンドポイントに変更（INS-04, 05, 08）
   - **ナレッジベース**: INS-01, INS-03 は `dataset_ids` を実際のデータセットIDに変更

## 使用ノードタイプ一覧

| ノードタイプ | 使用WF |
|---|---|
| start | INS-01〜10（全WF） |
| end | INS-01, 02, 04〜10 |
| answer | INS-03 |
| llm | INS-01〜10（全WF） |
| knowledge-retrieval | INS-01, 03 |
| question-classifier | INS-03, 06 |
| parameter-extractor | INS-02, 09 |
| if-else | INS-02, 04 |
| code | INS-02, 04, 05, 07, 08, 09, 10 |
| http-request | INS-04, 05, 08 |
| template-transform | INS-02, 04, 09 |
| variable-aggregator | INS-02, 04, 06 |
| iteration | INS-05, 10 |

## 設計上の考慮事項（保険業固有）

- **個人情報保護**: 全LLMシステムプロンプトに個人情報（保険証券番号、契約者名等）の生成・推測禁止を明記
- **保険業法コンプライアンス**: 保険業法300条（保険募集の際の禁止行為）に基づく断定的判断の提供禁止、比較表示の制限を遵守
- **適合性原則**: 保険商品の推奨において顧客属性・ニーズ・リスク許容度を考慮（INS-08, 10）
- **告知義務**: 引受査定において告知内容に基づく適切なリスク評価を実施（INS-07）
- **クーリングオフ**: 保険契約におけるクーリングオフ制度（8日間）への言及（INS-08）
- **免責事由**: 約款に基づく免責事由の正確な引用、安易な適用判断の回避（INS-01, 04, 09）
- **不正請求防止**: SIU（特別調査部門）との連携設計、疑わしい場合は安全側（厳格側）に判定（INS-04）
- **保険金支払管理態勢**: 支払漏れ防止のための適切な査定プロセスの支援（INS-02, 09）
- **エスカレーション**: 自動判定で処理完結せず、必要に応じて人間の専門家に引き継ぐ設計
- **監査証跡**: End/Answer ノードで全結果を出力し、後続の記録・監査に対応

## 前提条件

- Dify v0.6 以上
- OpenAI API キー（または互換モデルプロバイダー）が設定済み
- INS-01, INS-03 はナレッジベース（データセット）の事前作成が必要
- INS-04, INS-05, INS-08 は外部API（`api.example.com`）のダミーURL使用。実運用時は実APIに変更
