# BNK-03: 顧客問い合わせ対応チャット — 環境設定手順書

BNK-03 を Dify Cloud にインポートして動作させるまでの手順です。

---

## 概要

| 項目 | 内容 |
|------|------|
| ワークフロー名 | BNK-03: 顧客問い合わせ対応チャット |
| モード | Chatflow（`advanced-chat`） |
| ノード数 | 11 |
| 使用モデル | gpt-4o-mini（OpenAI） |
| ナレッジベース | 口座サービスご案内（口座ブランチのみ） |

### フロー構成

```
開始 → 問い合わせ分類(QC)
         ├── 口座 → 口座KB検索(KR) → 口座対応LLM(RAG) → 口座回答
         ├── ローン → ローン対応LLM → ローン回答
         ├── カード → カード対応LLM → カード回答
         └── その他 → 一般対応LLM → 一般回答
```

---

## 前提条件

- [ ] Dify Cloud アカウント（https://cloud.dify.ai）
- [ ] OpenAI API キーが Dify Cloud に設定済み（設定 → モデルプロバイダー → OpenAI）
- [ ] `gpt-4o-mini` が利用可能な状態

---

## Step 1: ナレッジベースの作成

口座ブランチで使用するナレッジベースを作成します。

### 1-1. ソースファイルの確認

```
industry/banking/test-env/knowledge-bases/account-kb.md
```

口座開設、口座種類、解約、通帳再発行、振込手数料、インターネットバンキング等の情報を含むドキュメントです。

### 1-2. Dify Cloud でナレッジベースを作成

1. Dify Cloud にログイン
2. 上部ナビの「**ナレッジ**」をクリック
3. 「**ナレッジを作成**」をクリック
4. ナレッジ名を入力（例: `口座サービスご案内`）
5. `account-kb.md` をアップロード（ドラッグ＆ドロップ可）
6. インデックス方式: 「**高品質**」を選択（推奨）
7. 「**保存して処理**」をクリック
8. インデックス処理完了を待つ（数十秒〜数分）

### 1-3. ナレッジベース UUID の取得

1. 作成したナレッジベースを開く
2. ブラウザの URL バーから UUID を取得

```
https://cloud.dify.ai/datasets/【この部分がUUID】/documents
                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
例: c0cc0da0-2558-4006-8177-1a6b713fd228
```

---

## Step 2: DSL ファイルの dataset_id を書き換え

`bnk-03-customer-inquiry.yml` の Knowledge Retrieval ノードに、取得した UUID を設定します。

### 2-1. 該当箇所

```yaml
# 口座KB検索 ノード（id: '30300000000003'）
dataset_ids:
- 'ここにStep1-3で取得したUUIDを貼り付け'
```

### 2-2. 書き換え例

```yaml
dataset_ids:
- 'c0cc0da0-2558-4006-8177-1a6b713fd228'  # ← 実際のUUIDに置換
```

> **注意**: UUID はシングルクォートで囲むこと。プレースホルダーのまま残すとインポートは成功するが実行時にエラーになります。

---

## Step 3: Dify Cloud へインポート

1. Dify Cloud にログイン
2. 「**スタジオ**」→ 右上「**DSLをインポート**」
3. `bnk-03-customer-inquiry.yml` を選択してアップロード
4. インポート完了後、キャンバスが表示される

### 確認ポイント

- [ ] ノードが 11 個表示されている（開始 + QC + KR + LLM×4 + Answer×4）
- [ ] 全ノードにエラーマーク（赤アイコン）がない
- [ ] 口座KB検索ノードをクリックし、ナレッジベースが正しく紐づいている

---

## Step 4: 動作テスト

右上の「**プレビュー**」をクリックし、以下の質問で各ブランチをテストします。

### 4-1. 口座ブランチ（RAG）

| テスト質問 | 期待動作 |
|-----------|---------|
| `口座の残高を確認したいのですが` | KR で口座KB を検索 → 口座対応LLM が KB 情報に基づき回答 |
| `普通預金の金利を教えてください` | KB 内の金利情報（年0.020%）を含む回答 |
| `振込手数料はいくらですか` | KB 内の手数料表を参照した回答 |
| `通帳を再発行したいのですが` | 再発行手数料1,100円、必要書類等の回答 |

**確認**: 回答がナレッジベースの内容に基づいていること（ハルシネーションでないこと）

### 4-2. ローンブランチ

| テスト質問 | 期待動作 |
|-----------|---------|
| `住宅ローンについて相談したいです` | ローン対応LLM が回答（KB なし） |
| `教育ローンの審査に必要な書類は` | ローン関連の一般的な案内 |

### 4-3. カードブランチ

| テスト質問 | 期待動作 |
|-----------|---------|
| `クレジットカードのポイントについて教えてください` | カード対応LLM が回答 |
| `キャッシュカードを紛失しました` | カード停止窓口（0120-XXX-YYYY）への連絡案内 |

### 4-4. その他ブランチ

| テスト質問 | 期待動作 |
|-----------|---------|
| `営業時間を教えてください` | 一般対応LLM が回答 |
| `ATM はどこにありますか` | 店舗・ATM 案内 |

---

## Step 5:（任意）sensitive_word_avoidance の有効化

全ブランチの動作確認後、必要に応じてキーワードフィルターを有効化します。

### 5-1. DSL ファイルを編集

```yaml
# 変更前
sensitive_word_avoidance:
  enabled: false

# 変更後
sensitive_word_avoidance:
  enabled: true
  type: keywords
  config:
    keywords: "爆弾\n殺害\n違法薬物\nハッキング手法"
    inputs_config:
      enabled: true
      preset_response: "その内容にはお答えできません。別の質問をお願いします。"
    outputs_config:
      enabled: true
      preset_response: "適切な回答を生成できませんでした。質問を変えてください。"
```

### 5-2. 再インポート

1. 既存の BNK-03 アプリを**削除**
2. 修正した YAML を再インポート
3. 通常の質問が引き続き動作することを確認

> **重要**: 上書きインポートではなく、削除→新規インポートを推奨。古い設定が残る場合があります。

---

## トラブルシューティング

| 症状 | 原因 | 対処 |
|------|------|------|
| インポート成功するが口座質問で応答なし | `dataset_ids` のUUIDが間違っている or KBが空 | ナレッジページでUUIDを再確認、KB内のドキュメント状態を確認 |
| 全ブランチで応答なし | LLM ノードの `memory` 設定が不完全 | `memory` キーが存在する場合は完全構造にするか削除（[ゴールデンルール #17](../DIFY_WORKFLOW_GOLDEN_RULES.md)参照） |
| QC の分類が正しくない | 分類指示が不十分 | `instruction` フィールドにキーワード例を追加 |
| 「モデルが設定されていません」エラー | OpenAI API キー未設定 | Dify 設定 → モデルプロバイダー → OpenAI でAPIキーを設定 |
| sensitive_word_avoidance 有効化後にエラー | `config` の構造が不正 | `configs`（複数形）ではなく `config`（単数形）を使用、`keywords` はリストでなく改行区切り文字列 |

---

## ファイル一覧

| ファイル | 用途 |
|---------|------|
| `bnk-03-customer-inquiry.yml` | 本体 DSL（Dify にインポート） |
| `bnk-03-test-minimal.yml` | 最小構成テスト用（デバッグ時に使用） |
| `test-env/knowledge-bases/account-kb.md` | 口座ナレッジベースのソースドキュメント |
| `bnk-03-setup-guide.md` | 本手順書 |
